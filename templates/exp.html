<!doctype html>
<html>
    
    <head>
        <title>jspsych + psiturk example - simple go/no-go reaction time test</title>
        <script src="/static/lib/jquery-min.js" type="text/javascript"></script>
        <script src="/static/lib/underscore-min.js" type="text/javascript"></script>
        <script src="/static/lib/backbone-min.js" type="text/javascript"></script>
        
        <script src="/static/js/jspsych/jspsych.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/plugins/jspsych-text.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/plugins/jspsych-single-stim.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/plugins/jspsych-multi-stim-multi-response.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/plugins/jspsych-categorize.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/plugins/jspsych-call-function.js" type="text/javascript"></script>

        <script type="text/javascript">
            // These fields provided by the psiTurk Server
            var uniqueId = "{{ uniqueId }}"; // a unique string identifying the worker/task
            var adServerLoc = "{{ adServerLoc }}"; // the location of your ad (so you can send user back at end of experiment)
            var mode = "{{ mode }}"; // is this running live, sandbox, or in debug mode?
        </script>
        
        <!-- utils.js and psiturk.js provide the basic psiturk functionality -->
        <script src="/static/js/utils.js" type="text/javascript"></script>
        <script src="/static/js/psiturk.js" type="text/javascript"></script>
        
        <link href="/static/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>
    
    <body>
        <div id='jspsych-target'></div>
    </body>
    <script>
        /* load psiturk */
        var psiturk = new PsiTurk(uniqueId, adServerLoc, mode);

        /* text blocks */

        var welcome_block = {
            type: "text",
            text: "Welcome to the experiment. Press any key to begin."
        };

        var instructions_block = {
            type: "text",
            text: "<p>In this experiment, you will read a sentence. Shortly after, a graph will appear in the center" +
                " of the screen.</p><p>If the graph accurately represents <strong>all</strong> parts" + 
                " of the information from the sentence shown, " + 
                "type the letter Y on the keyboard. Otherwise, press the letter N on the keyboard. " + 
                "It is important to press the Y or N key <strong>as fast as you can</strong>.</p>" +
                "<p>Example:</p> <center><h3 class='center'>Mia buys fewer packs of gum each year.</h3></center>" +
                "<div class='left center-content'><img width='400' src='/static/images/plots/good/Packs-vertical.png'></img>" + 
                "<p class='small'><strong>Press the Y key</strong></p></div>" + 
                "<div class='right center-content'><img width='400' src='/static/images/plots/wrong-data/Packs-topright.png'></img>" + 
                "<p class='small'><strong>Press the N key</strong></p></div>" + "<p></p>" +
                "<center><p>Press any key to begin.</p></center>",
                
            timing_post_trial: 2000
        };


        var trial_types = jsPsych.randomization.repeat(["good", "good", "good", "good", "catch", "catch", "wrong-data", "wrong-data"], 1);


        //Note: Packs will be the example
        var things = ['Pages', 'Panes', 'Pearls', 'Pears', 'Photos', 'Pills', 'Poems', 'Prices'];
        var texts = ['Mel writes more pages of her book each year.', 'Every year Mia cleans fewer window panes.', 'Mya sells more pearls every year.', 'Min sells the same number of pears each year.', 'Mab takes more photos every year', 'Meg prescribes 15 kinds of pills every year.', 'Mae writes 12 poems every year.', 'May lowers the price of her product every year.']
        var vignettes = _.map(texts, function (text) {
            return "<center><h1>" + text + "</h1></center>";
        })

        things_and_vignettes = jsPsych.randomization.repeat(_.zip(things,vignettes), 1);

        var styles = jsPsych.randomization.repeat(['left', 'rotated-c', 'rotated-cc', 'topleft', 'topright', 'vertical'], 1);
        styles.push('left', 'rotated-c') //TODO: remove these, actually randomize the catch trials

        var trials = [];
        function get_image(thing, style, trial_type) {
            return '<img src="/static/images/plots/' + trial_type + '/'+ thing + '-' + style + '.png"></img>'
        }
        
        for (var i = 0; i < 8; i++) {
            trials.push([things_and_vignettes[i][1], get_image(things_and_vignettes[i][0], styles[i], trial_types[i])]);
        }

        var post_trial_gap = function() {
            return Math.floor(Math.random() * 1500) + 750;
        };
        
        console.log(trials);
        var test_block = {
            type: "multi-stim-multi-response",
            stimuli: trials,
            choices: [[89,78]],
            is_html: true,
            timing_stim: [4000, -1],
            timing_response: -1,
            response_ends_trial: true
            // timing_post_trial: post_trial_gap,
            // data: all_trials.data
        };

        /* debrief block */

        var debrief_block = {
            type: "text",
            text: function() {
                return "<p>Your average response time was <strong>" + 
                getAverageResponseTime() + "ms</strong>. Press " + 
                "any key to complete the experiment. Thank you!</p>";
            }
        };

        function getAverageResponseTime() {

            var trials = jsPsych.dataAPI.getTrialsOfType('multi-stim-multi-response');

            var sum_rt = 0;
            var valid_trial_count = 0;
            for (var i = 0; i < trials.length; i++) {
                if (trials[i].response == 'go' && trials[i].rt > -1) {
                    sum_rt += trials[i].rt;
                    valid_trial_count++;
                }
            }
            return Math.floor(sum_rt / valid_trial_count);
        }


        /* define experiment structure */

        var experiment_blocks = [];

        experiment_blocks.push(welcome_block);
        experiment_blocks.push(instructions_block);
        experiment_blocks.push(test_block);
        experiment_blocks.push(debrief_block);


        /* start the experiment */

        jsPsych.init({
            display_element: $('#jspsych-target'),
            experiment_structure: experiment_blocks,
            on_finish: jsPsych.data.displayData,
            // },
            // on_finish: function() {
            //     psiturk.saveData({
            //         success: function() { psiturk.completeHIT(); }
            //     });
            // },
            on_data_update: function(data) {
                psiturk.recordTrialData(data);
            }
        });
    </script>

</html>
